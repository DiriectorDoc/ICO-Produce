<!DOCTYPE html>
<html lang="en-CA">
	<head>
		<title>ICO Produce</title>
		<meta name="description" content="Home page" />
		<meta name="author" content="Diriector_Doc" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="last-updated" content="Wed, 14 Apr 2021 17:26 GMT" />
		<meta name="keywords" content="diriector_doc, diriectordoc, diriector doc, website, ico, milti-resolution, multiresolution, png, create, generate, icon, convert, jpeg, jpg, filetypes, files, file type, produce" />
		<meta property="og:title" content="ICO Produce" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://diriectordoc.github.io/ICO-Produce" />
		<meta property="og:image" content="https://diriectordoc.github.io/ICO-Produce/img/produce.png" />
		<meta property="og:image:type" content="image/png" />
		<meta property="og:image:width" content="512" />
		<meta property="og:image:height" content="490" />
		<meta property="og:description" content="Multiresolution ICO file generator." />
		<meta property="og:locale" content="en_CA" />
		<meta property="og:site_name" content="Diriector_Doc Pages" />
		<link href="../global.css" rel="stylesheet" type="text/css" />
		<link href="main.css" rel="stylesheet" type="text/css" />
		<link href="icon/icon.ico" rel="icon" type="image/x-icon" />
		<script type="text/javascript" src="../global.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
        <script type="module">
			import * as Magick from "https://cdn.jsdelivr.net/npm/wasm-imagemagick/dist/bundles/magickApi.js";

			async function command(files, command){
				return await Magick.Call(files, command.split(" "))
			}

			const /*args = {},*/
				  preparedImages = [],
				  inputImages = [];

			/*for(const [k, v] of new URLSearchParams(location.href)){
				args[k] = v
			}*/

			$(function(){
				if(window.isIE){
					alert("You are using Internet Explorer. This interface can only be used on modern browsers.")
					return
				}
				let U8File = function(source, name){
						this.content = new Uint8Array(source);
						this.name = name;
					},
					imagesToICO = async function(inputFiles){
						const cmd = "convert";
						for(let e of inputFiles){
							cmd += e.name
						}
						cmd += "icon.jpg";
						let processedFile = (await command(inputFiles, cmd))[0]
						$(".input-images").append(`<img src="${URL.createObjectURL(processedFile.blob)}" />`)
						console.log("created image " + processedFile.name)
					};
				$("input").change(async function(){
					$(".loading").show()
					preparedImages.length = inputImages.length = 0;
					for(let e of this.files){
						let name = e.name.replaceAll(" ", "_");
						await new Promise((resolve, reject) => {
							let img = new Image();
							img.onload = async () => {
								if(img.width != img.height || img.width > 256){
									let buffer,
										max = Math.max(img.width, img.height),
										aspect = max >= 256 ? 256 : max;
									await e.arrayBuffer().then(arrayBuffer => {
										buffer = arrayBuffer
									});
									e = (await command([new U8File(buffer, name)], `convert -background none -gravity center ${name} -resize ${aspect}x${aspect} -extent ${aspect}x${aspect} ${name}.png`))[0];
									img.src = URL.createObjectURL(e.blob)
								}
								inputImages.push(img)
								resolve()
							};
							img.onerror = reject;
							img.src = URL.createObjectURL(e)
						})
						preparedImages.push(e)
					}
					for(let e of preparedImages){
						$(".input-images").append(`<img src="${URL.createObjectURL(e.blob ?? e)}" />`)
					}
					$(".loading").hide()
					//imagesToICO(inputFiles)
				})
			})
		</script>
    </head>
    <body>
		<div class="container">
			<div class="social">
				<a href="https://github.com/DiriectorDoc/ICO-Produce" class="github"></a>
			</div>
			<div class="content-wrapper">
				<h1><img src="img/produce.png" height="80" /><span>ICO Produce</span></h1>
				<div class="input-button">
					<label><input type="file" accept="image/png, image/jpeg, image/x-icon, image/bmp, image/gif" multiple />Select Image</label>
				</div>
				<div class="input-images">
					<img class="loading" src="img/loading.png" style="display:none" />
				</div>
			</div>
			<div class="footer asf"></div>
		</div>
    </body>
</html>